<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.acctmgmt.mapper.BgtCDMapper">
	
	<select id="getDataGridData" resultType="BgtCD">
		SELECT * FROM BGTCD ;
	</select>
	<select id="getBGTCDData" parameterType="String" resultType="BgtCD">
		SELECT * FROM BGTCD where GROUP_CD=#{GROUPCD};
	</select>

	<select id="getDetailInfo" parameterType="String" resultType="BgtCD">
		SELECT CTL_FG ,BGAJUST_FG ,TO_DT , BOTTOM_FG , BIZ_FG FROM BGTCD WHERE BGT_CD=#{bgtCd};
	</select>
	<select id="getDefNmFromBGTCD_TERM" parameterType="String" resultType="String">
		SELECT DEF_NM from BGTCD_TERM where DIV_FG =#{divFg};
	</select>
	<select id="getBgtCDDataForPath" parameterType="String" resultType="BgtCD">
		SELECT * FROM BGTCD
		WHERE BGT_CD=#{bgtCd}
	</select>
	<select id="getBgtCDTerm" parameterType="String" resultType="BgtCDTerm">
		SELECT * FROM 
		BGTCD_TERM
		where CO_CD = #{coCd}
	</select>
	<select id="getDataPath" parameterType="BgtCd" resultType="String">
		SELECT DEF_NM FROM 
		BGTCD_TERM
		WHERE CO_CD=#{coCd} AND DIV_FG=#{divFg}
	</select>
	<select id="getPath" parameterType="String" resultType="String">
		SELECT dataPath 
		FROM BGTCD
		WHERE BGT_CD=#{bgtCd}
	
	</select>
	<select id="getBgtGrData" parameterType="String" resultType="BgtGr">
		SELECT * FROM BGTGR WHERE CO_CD=#{coCd};
	</select>
	
	<update id="updateDetailInfo" parameterType="BgtCD">
		UPDATE BGTCD
		<set>
			<if test="ctlFg != null">CTL_FG=#{ctlFg},</if>
			<if test="bgajustFg != null">BGAJUST_FG=#{bgajustFg},</if>
			<if test="toDt != null">TO_DT=#{toDt},</if>
			<if test="bottomFg != null">BOTTOM_FG=#{bottomFg},</if>
			<if test="bizFg != null">BIZ_FG=#{bizFg},</if>
		</set>
		WHERE bgt_Cd =#{bgtCd}
	</update>
	<update id = "updateBgtCDTerm" parameterType="BgtCDTerm">
		UPDATE BGTCD_TERM
		SET DEF_NM=#{defNm}
		WHERE
		CO_CD=#{coCd} and DIV_FG=#{divFg}
	</update>
	
	<!-- <select id = "findBgcCDByGroupCdAndToDtAndKeyword" parameterType="BgtCD" resultType="BgtCD">
		SELECT *
		FROM BGTCD
		LEFT JOIN BGTGR ON BGTCD.GROUP_CD = BGTGR.BGTGR_CD
		WHERE BGTCD.CO_CD = #{coCd} 
		<if test="gisu != 0 or (gisu != null and gisu != '')">
	    AND BGTCD.GISU = #{gisu}
	 	</if>
		AND BGTCD.TO_DT >= #{toDt} 
		<if test="groupCd != null and groupCd != ''">
			AND BGTCD.GROUP_CD = #{groupCd}
		</if>
		<if test="keyword != null and keyword != ''">
	        AND (
	            BGTCD.BGT_CD LIKE CONCAT('%', #{keyword}, '%')
	            OR
	            BGTCD.BGT_NM LIKE CONCAT('%', #{keyword}, '%')
	        )
	    </if>
	</select> -->
	
	
	<select id ="findBgcCDByGroupCdAndToDtAndKeyword" parameterType="BgtCD" resultType="BgtCD">
		SELECT
		    BGTCD.GISU,
		    BGTGR.BGTGR_NM,
		    BGTCD.BGT_CD AS BGT_CD,
		    BGTCD.BGT_NM,
		    (
		        SELECT GROUP_CONCAT(BGT_NM SEPARATOR ' > ')
		        FROM BGTCD bgtcd_sub
		        WHERE FIND_IN_SET(bgtcd_sub.BGT_CD, BGTCD.DATAPATH)
		    ) AS DATA_PATH
		FROM
		    BGTCD
		LEFT JOIN
		    BGTGR ON BGTCD.GROUP_CD = BGTGR.BGTGR_CD
		    WHERE BGTCD.CO_CD = #{coCd} 
		<if test="gisu != 0 or (gisu != null and gisu != '')">
	    AND BGTCD.GISU = #{gisu}
	 	</if>
		AND BGTCD.TO_DT >= #{toDt} 
		<if test="groupCd != null and groupCd != ''">
			AND BGTCD.GROUP_CD = #{groupCd}
		</if>
		<if test="keyword != null and keyword != ''">
	        AND (
	            BGTCD.BGT_CD LIKE CONCAT('%', #{keyword}, '%')
	            OR
	            BGTCD.BGT_NM LIKE CONCAT('%', #{keyword}, '%')
	        )
	    </if>
	</select>
	
	<select id="findUseParentCdSubject"  parameterType="String">
		SELECT COUNT(*) FROM BGTCD WHERE parentCd = #{bgtCd}
	</select>
	<delete id="deleteRow" parameterType="String">
		DELETE FROM BGTCD
		WHERE bgt_Cd = #{bgtCd}
	</delete>
	
	
	<select id="findBgtCdByGisuAndGroupCdAndGrFgAndBgtCd" parameterType="BgtCD" resultType="BgtCD">
		SELECT DISTINCT 
			BGTCD.CO_CD,
		    BgtCD.bgt_Cd AS bgt_Cd,
		    CASE 
		        WHEN bgtcd.div_Fg BETWEEN '1' AND '8' THEN (
		            SELECT BgtCD_Term.def_Nm
		            FROM BgtCD_Term
		            WHERE BgtCD_Term.co_Cd = bgtcd.co_Cd AND BgtCD_Term.div_Fg = bgtcd.div_Fg
		        )
		        ELSE bgtcd.div_Fg
		    END AS div_Fg,
		    CASE
		        WHEN BgtCD.dataPath IS NULL THEN BgtCD.bgt_nm
		        ELSE (
		            SELECT CONCAT(
		                GROUP_CONCAT(bgt_nm SEPARATOR ' > '),
		                ' > ',
		                BgtCD.bgt_nm
		            )
		            FROM BgtCD bgtcd_sub
		            WHERE FIND_IN_SET(bgtcd_sub.bgt_Cd, BgtCD.dataPath)
		        )
		    END AS dataPath
		FROM
		    BgtCD
		LEFT JOIN
		    BgtICF ON BgtCD.bgt_Cd = BgtICF.bgt_Cd
		WHERE 
			BGTICF.DIV_CD = #{divCd}
			AND
			BGTCD.GISU = #{gisu}
			AND
			BGTCD.GROUP_CD = #{groupCd}
			AND
			BGTCD.GR_FG = #{grFg}
			AND
			BGTCD.BGT_CD = #{bgtCd}
		ORDER BY BgtCD.BGT_Cd
	</select>
</mapper>